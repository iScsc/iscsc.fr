version: "3.8"

services:
  mongodb:
    image: docker.io/bitnami/mongodb:latest
    networks:
      - database
    env_file: ./.env.development
    environment:
      - "MONGODB_PORT_NUMBER=$DB_PORT"
    ports:
      - $DB_PORT:$DB_PORT
    volumes:
      - "./mongodb/dev:/bitnami/mongodb:rw"

  flask-app-dev:
    depends_on:
      - mongodb
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    networks:
      - database
      - proxy
    env_file: ./.env.development
    ports:
      - $FLASK_RUN_PORT:$FLASK_RUN_PORT
    volumes:
      - ./backend/app.py:/backend/app.py:ro
      - ./backend/controllers:/backend/controllers:ro
      - ./backend/middleware:/backend/middleware:ro
      - ./backend/models:/backend/models:ro
      - ./backend/routes:/backend/routes:ro

  react-app-dev:
    depends_on:
      - flask-app-dev
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    networks:
      - proxy
    env_file: ./.env.development
    ports:
      - $REACT_PORT:$REACT_PORT
    volumes:
      - "./frontend/public:/frontend/public:ro"
      - "./frontend/src:/frontend/src:ro"

  nginx:
    depends_on:
      - react-app-dev
      - flask-app-dev
      - mongodb
    build:
      context: ./nginx
      args:
        - FLASK_RUN_PORT=$FLASK_RUN_PORT
        - REACT_PORT=$REACT_PORT
        - SERVER_NAME=$SERVER_NAME
        - MODE=$MODE
    networks:
      - proxy
    ports:
      - 80:80

networks:
  proxy:
  database:
